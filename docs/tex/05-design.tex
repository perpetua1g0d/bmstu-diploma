\chapter{Конструкторский раздел}

\section{Алгоритм аутентификации инфраструктурного сервиса}
Для аутентификации сервиса-клиента, выполняющего подписанный запрос из сайдкар контейнера, необходим k8s токен пода, который хранится по пути с секретами. В обмен на этот k8s токен, idP сервис выпускает токен аутентификации, который будет использоваться для подписи запроса от имени сервиса-клиента. На рисунке~\ref{img:service_auth_alg} представлен алгоритм аутентификации сервиса-клиента.

\includeimage
    {service_auth_alg}
    {f}
    {H}
    {0.4\textwidth}
    {Алгоритм аутентификации инфраструктурного сервиса}

\pagebreak

\section{Алгоритм верификации k8s токена на стороне idP}
Для того, чтобы подтвердить подлинность k8s токена и личность, от имени которого он был выписан, idP сервису нужен получить JWKs сертификаты от Kubernetes API, с помощью них расшифровать JWT токен и затем его проверить. Алгоритм верификации k8s токена представлен на рисунке~\ref{img:k8s_verify_alg}.

\includeimage
    {k8s_verify_alg}
    {f}
    {H}
    {0.4\textwidth}
    {Алгоритм верификации k8s токена}

%\section{Алгоритм обмена k8s токена на idP токен}

\pagebreak

\section{Обработчики HTTP запросов к idP}

idP сервису необходимо реализовать REST API, чтобы в него могли ходить за выпуском токена.
OIDC стандарт предлагает следующий контракт:

\begin{enumerate}
\item ~\textit{/realms/infra2infra/.well-known/openid-configuration} --- обработчик запросов на получение OIDC конфигурации. Конфигурация должна содержать адреса и пути обработчиков запросов на выпуск токена и получения сертификатов, адрес issuer --- где был выпущен токен, чтобы потом это проверить;
%\item ~\textit{/realms/infra2infra/protocol/openid-connect/token} --- обработчик запросов на выпуск и получение токена idP. Параметрами для запроса могут быть "grant_type" --- способ проверки личности, в данном случае token-exchange, "subject_token" --- сам токен для обмена, "subject_token_type" --- тип токена для обмена, "scope" --- в какую сущность выписывается токен;
\item ~\textit{/realms/infra2infra/protocol/openid-connect/token} --- обработчик запросов на выпуск и получение токена idP. Параметрами для запроса могут быть \textit{"grant\_type"} --- способ проверки личности, в данном случае token-exchange, \textit{"subject\_token"} --- сам токен для обмена, \textit{"subject\_token\_type"} --- тип токена для обмена, \textit{"scope"} --- в какую сущность выписывается токен;
\item ~\textit{/realms/infra2infra/protocol/openid-connect/certs} --- обработчик запросов на получение сертификатов idP, возвращает публичный ключ сертификатов вместе с key-id.
\end{enumerate}

\section*{Вывод}
В данном разделе были спроектированы основные алгоритмы, необходимые для работы аутентификации, а также контракт общения idP и сервисов клиента по REST API.